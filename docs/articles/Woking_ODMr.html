<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Working with ODMr • ODMr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Working with ODMr">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ODMr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/ODMr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ODM_notes.html">ODM notes</a>
    </li>
    <li>
      <a href="../articles/Woking_ODMr.html">Working with ODMr</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Working with ODMr</h1>
                        <h4 class="author">Chris McConnell</h4>
            
            <h4 class="date">2020-03-03</h4>
      
      
      <div class="hidden name"><code>Woking_ODMr.Rmd</code></div>

    </div>

    
    
<div id="projects" class="section level2">
<h2 class="hasAnchor">
<a href="#projects" class="anchor"></a>Projects</h2>
<p>Any process running on your computer has a notion of its “working directory”. In R, this is where R will look, by default, for files you ask it to load. It is also where, by default, any files you write to disk will go.</p>
<p>RStudio provides a very useful “project” feature that allows a user to switch quickly between projects. Each project may have different working directories and collection of files. The current project name is listed on the far right of the main application toolbar in a combobox that allows one to switch between an open project, open an existing project, or create a new project.</p>
<p>Do this: Within the project combobox select New Project. The directory name you choose here will be the project name. Call it whatever you want (good names are short and informative). Keep your “good” R code in a script for future reuse. Click on the floppy disk to save. Give it a name; it will go in the directory associated with your project.</p>
</div>
<div id="calculating-flow" class="section level2">
<h2 class="hasAnchor">
<a href="#calculating-flow" class="anchor"></a>Calculating Flow</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">flow &lt;-<span class="st"> </span><span class="cf">function</span>(h, p, e, n) {</a>
<a class="sourceLine" id="cb1-2" title="2">  p <span class="op">*</span><span class="st"> </span>(h <span class="op">-</span><span class="st"> </span>e) <span class="op">^</span>n</a>
<a class="sourceLine" id="cb1-3" title="3">}</a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5">Q &lt;-</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span> (Stage<span class="op">$</span>DataValue <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.534</span>, <span class="kw">flow</span>(Stage<span class="op">$</span>DataValue, <span class="fl">1241.9</span>, <span class="fl">0.489</span>, <span class="fl">1.32</span>),</a>
<a class="sourceLine" id="cb1-7" title="7">          <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span> (Stage<span class="op">$</span>DataValue <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.353</span>, <span class="kw">flow</span>(Stage<span class="op">$</span>DataValue, <span class="fl">985.52</span>, <span class="fl">0.353</span>, <span class="fl">2.26</span>),</a>
<a class="sourceLine" id="cb1-8" title="8">                  <span class="dv">0</span>))</a></code></pre></div>
</div>
<div id="combining-series" class="section level2">
<h2 class="hasAnchor">
<a href="#combining-series" class="anchor"></a>Combining Series</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">ODM_combine &lt;-<span class="st"> </span><span class="cf">function</span> (x, y) {</a>
<a class="sourceLine" id="cb2-2" title="2">    <span class="kw">full_join</span>(x, y[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"LocalDateTime"</span>, <span class="st">"DataValue"</span>, <span class="st">"QualifierID"</span>)], </a>
<a class="sourceLine" id="cb2-3" title="3">              <span class="dt">by =</span> <span class="st">"LocalDateTime"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="st">        </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb2-5" title="5">            <span class="dt">QualifierID =</span> </a>
<a class="sourceLine" id="cb2-6" title="6">                <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(.data<span class="op">$</span>DataValue.x), .data<span class="op">$</span>QualifierID.y, .data<span class="op">$</span>QualifierID.x),</a>
<a class="sourceLine" id="cb2-7" title="7">            <span class="dt">DataValue =</span> </a>
<a class="sourceLine" id="cb2-8" title="8">                <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(.data<span class="op">$</span>DataValue.x), .data<span class="op">$</span>DataValue.y, .data<span class="op">$</span>DataValue.x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="st">        </span><span class="kw">select</span>(<span class="op">-</span>DataValue.x, <span class="op">-</span>DataValue.y, <span class="op">-</span>QualifierID.x, <span class="op">-</span>QualifierID.y)</a>
<a class="sourceLine" id="cb2-10" title="10">}</a>
<a class="sourceLine" id="cb2-11" title="11"></a>
<a class="sourceLine" id="cb2-12" title="12">tmp &lt;-<span class="st"> </span><span class="kw">ODM_combine</span>(<span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(ODMdata, QualityControlLevelID <span class="op">==</span><span class="st"> </span><span class="dv">2</span>), <span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(ODMdata, QualityControlLevelID <span class="op">==</span><span class="st"> </span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb2-13" title="13"></a>
<a class="sourceLine" id="cb2-14" title="14">tmp &lt;-<span class="st"> </span>tmp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fill</span>(UTCOffset<span class="op">:</span>QualityControlLevelID)</a></code></pre></div>
</div>
<div id="data-profiling" class="section level2">
<h2 class="hasAnchor">
<a href="#data-profiling" class="anchor"></a>Data profiling</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">ggplot</span>(PC1_Stage_10min_<span class="dv">53</span>_<span class="dv">2</span>, <span class="kw">aes</span>(DataValue)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>()</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">ggplot</span>(PC1_Stage_10min_<span class="dv">53</span>_<span class="dv">2</span>, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="kw">month</span>(LocalDateTime)), </a>
<a class="sourceLine" id="cb3-3" title="3">  <span class="dt">y =</span> DataValue)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>()</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">ggplot</span>(PC1_Stage_10min_<span class="dv">53</span>_<span class="dv">2</span>, <span class="kw">aes</span>(LocalDateTime, <span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(DataValue))) <span class="op">+</span><span class="st"> </span><span class="kw">geom_raster</span>()</a>
<a class="sourceLine" id="cb3-5" title="5"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(PC1_Stage_10min_<span class="dv">53</span>_<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb3-6" title="6"><span class="kw"><a href="https://rdrr.io/r/stats/xtabs.html">xtabs</a></span>(<span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(DataValue,<span class="dv">2</span>), <span class="dt">data =</span> PC1_Stage_10min_<span class="dv">53</span>_<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb3-7" title="7"><span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(PC1_Stage_10min_<span class="dv">53</span>_<span class="dv">2</span><span class="op">$</span>DataValue, <span class="dt">na.rm =</span> T, </a>
<a class="sourceLine" id="cb3-8" title="8">         <span class="dt">probs =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="fl">0.01</span>,<span class="fl">0.1</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.9</span>,<span class="fl">0.99</span>,<span class="dv">1</span>))</a></code></pre></div>
</div>
<div id="example-workflow-manual-barometric-compensation" class="section level2">
<h2 class="hasAnchor">
<a href="#example-workflow-manual-barometric-compensation" class="anchor"></a>Example workflow – Manual Barometric Compensation</h2>
<p>Convert the barometric data column from its barometric measurement units (typically atm, mm Hg, psi, mbar or kPa) to meters of water column equivalent.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">PTMET_BarPre_10minAvg_2m_<span class="dv">12</span>_<span class="dv">1</span> &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="st">    </span><span class="kw"><a href="../reference/odm_read.html">odm_read</a></span>(<span class="dt">site_id =</span> <span class="dv">13</span>, <span class="dt">variable_id =</span> <span class="dv">100</span>, </a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="dt">method_id =</span> <span class="dv">12</span>, <span class="dt">level_id =</span> <span class="dv">1</span>)</a></code></pre></div>
<p>How many hPa in 1 meter of head? The answer is 98.04139432.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">Adj &lt;-<span class="st"> </span>PTMET_BarPre_10minAvg_2m_<span class="dv">12</span>_<span class="dv">1</span> <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">DataValue =</span> DataValue <span class="op">/</span><span class="st"> </span><span class="fl">98.04139432</span>)</a></code></pre></div>
<p>Merge the barometric corrections with the stage data and calculate the corrected stage values.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">PC1_Stage_10minAvg_<span class="dv">42</span>_<span class="dv">1</span> <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="st">    </span><span class="kw">left_join</span>(Adj[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"LocalDateTime"</span>,<span class="st">"DataValue"</span>)], <span class="dt">by =</span> <span class="st">"LocalDateTime"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">DataValue =</span> DataValue.x <span class="op">-</span><span class="st"> </span>DataValue.y)</a></code></pre></div>
</div>
<div id="useful-packages---lubridate" class="section level2">
<h2 class="hasAnchor">
<a href="#useful-packages---lubridate" class="anchor"></a>Useful packages - lubridate</h2>
<p>Parsing dates and times. Getting R to agree that your data contains the dates and times you think it does can be tricky. Lubridate simplifies that. Identify the order in which the year, month, and day appears in your dates. Now arrange “y”, “m”, and “d” in the same order.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(lubridate)</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">mdy</span>(<span class="st">"06-04-2011"</span>)</a></code></pre></div>
<p>If your date includes time information, add h, m, and/or s to the name of the function.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">ymd_hms</span>(<span class="st">"2011-06-04 12:00:00"</span>)</a></code></pre></div>
<p>Using paste to combine dates and times to create datetime objects.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">Date =<span class="st"> "2011-06-04"</span></a>
<a class="sourceLine" id="cb9-2" title="2">Time =<span class="st"> "12:00:00"</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="kw">ymd_hms</span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(Date, Time))</a></code></pre></div>
<p>Rounding to the nearest unit or multiple of a unit are supported. All meaningful specifications in English language are supported - secs, min, mins, 2 minutes, 3 years etc.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">round_date</span>(<span class="kw">ymd_hms</span>(<span class="st">"2011-06-04 12:03:00"</span>), <span class="dt">unit =</span> <span class="st">"10 minutes"</span>)</a>
<a class="sourceLine" id="cb10-2" title="2"><span class="kw">floor_date</span>(<span class="kw">ymd_hms</span>(<span class="st">"2011-06-04 12:03:00"</span>), <span class="dt">unit =</span> <span class="st">"month"</span>)</a>
<a class="sourceLine" id="cb10-3" title="3"><span class="kw">ceiling_date</span>(<span class="kw">ymd_hms</span>(<span class="st">"2011-06-04 12:03:00"</span>), <span class="dt">unit =</span> <span class="st">"10 minutes"</span>)</a></code></pre></div>
</div>
<div id="useful-packages---robfilter" class="section level2">
<h2 class="hasAnchor">
<a href="#useful-packages---robfilter" class="anchor"></a>Useful packages - robfilter</h2>
<p>robfilter is a package of functions for robust extraction of an underlying signal from time series. The simplest and quickest functions to use in the package are those applying robust regression techniques to moving time windows.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(robfilter)</a>
<a class="sourceLine" id="cb11-2" title="2">PC1_filtered &lt;-<span class="st"> </span><span class="kw">robreg.filter</span>(PC1_Stage_10minAvg_<span class="dv">1</span>_<span class="dv">1</span><span class="op">$</span>DataValue, <span class="dt">width =</span> <span class="dv">7</span>)</a>
<a class="sourceLine" id="cb11-3" title="3"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(PC1_filtered)</a></code></pre></div>
<p>robreg.filter returns an object of class robreg.filter containing the signal level extracted by the filter(s) specified.</p>
</div>
<div id="useful-packages---padr" class="section level2">
<h2 class="hasAnchor">
<a href="#useful-packages---padr" class="anchor"></a>Useful packages - padr</h2>
<p>When getting time series data ready for analysis, you might be confronted with the following two challenges: -The observations are done on too low a level, e.g. time recorded to the second, where your analysis is on a daily level. -There are no records for the time points where observations were absent. padr aims to make light work of preparing time series data by offering the two main functions thicken and pad.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(padr)</a>
<a class="sourceLine" id="cb12-2" title="2">PTMET_pad &lt;-<span class="st"> </span>PTMET_BarPre_10minAvg_2m_<span class="dv">12</span>_<span class="dv">1</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pad</span>()</a></code></pre></div>
<p>The pad function figures out what the datetime variable in the data frame is, and then assesses its interval. It inserts a row in the data frame for every time point that is lacking from the data set. All non-datetime values will get missing values at the added rows.</p>
<p>Sometimes this can be too memory intensive. An alternative is to use <code>complete()</code> from tidyr.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">PTMET_pad &lt;-<span class="st"> </span><span class="kw">complete</span>(PTMET_BarPre_10minAvg_2m_<span class="dv">12</span>_<span class="dv">1</span>, <span class="dt">LocalDateTime =</span> </a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(</a>
<a class="sourceLine" id="cb13-3" title="3">    <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(PTMET_BarPre_10minAvg_2m_<span class="dv">12</span>_<span class="dv">1</span><span class="op">$</span>LocalDateTime), </a>
<a class="sourceLine" id="cb13-4" title="4">    <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(PTMET_BarPre_10minAvg_2m_<span class="dv">12</span>_<span class="dv">1</span><span class="op">$</span>LocalDateTime), <span class="dt">by =</span> <span class="st">"10 min"</span>))</a></code></pre></div>
</div>
<div id="useful-packages---zoo" class="section level2">
<h2 class="hasAnchor">
<a href="#useful-packages---zoo" class="anchor"></a>Useful packages - zoo</h2>
<p>In zoo there are a few useful NA functions in particular: na.locf() na.appox() na.spline()</p>
<p>na.locf() stands for last observation carried forward and does just what it says. The last observation before NA or a string before NA is used to replace the NA. Runs of more than <code>maxgap</code> NAs are retained, other NAs are filled.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(zoo)</a>
<a class="sourceLine" id="cb14-2" title="2">PTMET_pad <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">DataValue =</span> <span class="kw">na.locf</span>(DataValue, <span class="dt">maxgap =</span> <span class="dv">1</span>))</a></code></pre></div>
<p>na.approx() uses linear interpolation to fill in missing values.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">PTMET_pad <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">DataValue =</span> <span class="kw">na.approx</span>(DataValue, <span class="dt">maxgap =</span> <span class="dv">6</span>))</a></code></pre></div>
<p>na.spline() uses polynomial interpolation to fill in missing data.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">PTMET_filled &lt;-<span class="st"> </span>PTMET_pad <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">DataValue =</span> <span class="kw">na.spline</span>(DataValue, <span class="dt">maxgap =</span> <span class="dv">6</span>))</a></code></pre></div>
<p>Using tidyr you’ll need to fill missing values in using the previous entry to ensure records contain all the required meta data fields like SiteID.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyr)</a>
<a class="sourceLine" id="cb17-2" title="2">PTMET_filled <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fill</span>(UTCOffset, SiteID, VariableID, MethodID, SourceID, QualityControlLevelID)</a></code></pre></div>
</div>
<div id="useful-code-bits---tsoutliers" class="section level2">
<h2 class="hasAnchor">
<a href="#useful-code-bits---tsoutliers" class="anchor"></a>Useful code bits - tsoutliers</h2>
<p>From Rob Hyndman - “Here is a simple R function that will find time series outliers. It will handle seasonal and non-seasonal time series. The basic idea is to find robust estimates of the trend and seasonal components and subtract them. Then find outliers in the residuals. The test for residual outliers is the same as for the standard boxplot – points greater than 1.5IQR above or below the upper and lower quartiles are assumed outliers. The number of IQRs above/below these thresholds is returned as an outlier”score“. So the score can be any positive number, and will be zero for non-outliers.”</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">tsoutliers &lt;-<span class="st"> </span><span class="cf">function</span>(x)</a>
<a class="sourceLine" id="cb18-2" title="2">{</a>
<a class="sourceLine" id="cb18-3" title="3">    x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/ts.html">as.ts</a></span>(x)</a>
<a class="sourceLine" id="cb18-4" title="4">    <span class="cf">if</span>(<span class="kw"><a href="https://rdrr.io/r/stats/time.html">frequency</a></span>(x)<span class="op">&gt;</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb18-5" title="5">        resid &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/stl.html">stl</a></span>(x,<span class="dt">s.window=</span><span class="st">"periodic"</span>,<span class="dt">robust=</span><span class="ot">TRUE</span>)<span class="op">$</span>time.series[,<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb18-6" title="6">    <span class="cf">else</span></a>
<a class="sourceLine" id="cb18-7" title="7">    {</a>
<a class="sourceLine" id="cb18-8" title="8">        tt &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(x)</a>
<a class="sourceLine" id="cb18-9" title="9">        resid &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/loess.html">loess</a></span>(x <span class="op">~</span><span class="st"> </span>tt))</a>
<a class="sourceLine" id="cb18-10" title="10">    }</a>
<a class="sourceLine" id="cb18-11" title="11">    resid.q &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(resid,<span class="dt">prob=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.25</span>,<span class="fl">0.75</span>))</a>
<a class="sourceLine" id="cb18-12" title="12">    iqr &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/diff.html">diff</a></span>(resid.q)</a>
<a class="sourceLine" id="cb18-13" title="13">    limits &lt;-<span class="st"> </span>resid.q <span class="op">+</span><span class="st"> </span><span class="fl">1.5</span><span class="op">*</span>iqr<span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb18-14" title="14">    score &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>((resid<span class="op">-</span>limits[<span class="dv">1</span>])<span class="op">/</span>iqr,<span class="dv">0</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>((resid <span class="op">-</span><span class="st"> </span>limits[<span class="dv">2</span>])<span class="op">/</span>iqr,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb18-15" title="15">    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(score)</a>
<a class="sourceLine" id="cb18-16" title="16">}</a></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">OUT &lt;-<span class="st"> </span>PTMET_BarPre_10minAvg_2m_<span class="dv">12</span>_<span class="dv">1</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">ol =</span> <span class="kw">tsoutliers</span>(DataValue)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(ol <span class="op">&gt;</span><span class="st"> </span><span class="fl">1.5</span>)</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#projects">Projects</a></li>
      <li><a href="#calculating-flow">Calculating Flow</a></li>
      <li><a href="#combining-series">Combining Series</a></li>
      <li><a href="#data-profiling">Data profiling</a></li>
      <li><a href="#example-workflow-manual-barometric-compensation">Example workflow – Manual Barometric Compensation</a></li>
      <li><a href="#useful-packages---lubridate">Useful packages - lubridate</a></li>
      <li><a href="#useful-packages---robfilter">Useful packages - robfilter</a></li>
      <li><a href="#useful-packages---padr">Useful packages - padr</a></li>
      <li><a href="#useful-packages---zoo">Useful packages - zoo</a></li>
      <li><a href="#useful-code-bits---tsoutliers">Useful code bits - tsoutliers</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Chris McConnell.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
